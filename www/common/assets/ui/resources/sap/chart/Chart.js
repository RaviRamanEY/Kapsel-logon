/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['sap/chart/library','sap/viz/ui5/controls/VizFrame','sap/viz/ui5/controls/common/BaseControl','sap/viz/ui5/data/Dataset','sap/viz/ui5/data/FlattenedDataset','sap/viz/ui5/data/DimensionDefinition','sap/viz/ui5/data/MeasureDefinition','sap/chart/data/Dimension','sap/chart/data/Measure','sap/ui/model/analytics/ODataModelAdapter','sap/chart/utils/RoleFitter','sap/chart/utils/ChartUtils','sap/chart/utils/SeriesColorTracker','sap/viz/ui5/controls/common/feeds/FeedItem','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/ui/model/analytics/odata4analytics','sap/ui/model/Sorter'],function(l,V,B,D,F,a,M,b,c,O,R,C,S,f,g,h,o,q){"use strict";var r=sap.chart.SelectionMode;var t=B.extend("sap.chart.Chart",{metadata:{library:"sap.chart",properties:{chartType:{type:"string",defaultValue:"bar"},uiConfig:{type:"object",group:"Misc"},visibleDimensions:{type:"string[]",defaultValue:[]},visibleMeasures:{type:"string[]",defaultValue:[]},vizProperties:{type:"object",group:"Misc"},vizScales:{type:"object[]",group:"Misc"},isAnalytical:{type:"boolean"},selectionBehavior:{type:"string",defaultValue:"DATAPOINT"},selectionMode:{type:"string",defaultValue:sap.chart.SelectionMode.Multi},enablePagination:{type:"boolean",defaultValue:false}},aggregations:{data:{type:"sap.ui.core.Element",multiple:true,bindable:"bindable"},_vizFrame:{type:"sap.viz.ui5.controls.VizFrame",multiple:false,visibility:"hidden"},dimensions:{type:"sap.chart.data.Dimension",multiple:true},measures:{type:"sap.chart.data.Measure",multiple:true}},events:{drilledDown:{parameters:{dimensions:{type:"string[]"}}},drilledUp:{parameters:{dimensions:{type:"string[]"}}},renderComplete:{},selectData:{},deselectData:{}}},renderer:function(d,e){d.write("<div");d.writeControlData(e);d.addStyle("width",e.getWidth());d.addStyle("height",e.getHeight());d.writeStyles();d.write(">");d.renderControl(e.getAggregation("_vizFrame"));d.write("</div>");}});t.getMetadata().getAggregation("data")._doesNotRequireFactory=true;function u(v){return v.indexOf("%")!==-1?"100%":v;}t.prototype.setHeight=function(v){this.setProperty("height",v);var d=this._getVizFrame();if(d){d.setHeight(u(this.getProperty("height")));}return this;};t.prototype.setWidth=function(v){this.setProperty("width",v);var d=this._getVizFrame();if(d){d.setWidth(u(this.getProperty("width")));}return this;};t.prototype.setChartType=function(s,d){this.setProperty("chartType",s,d);this._bIsPagingChartType=C.CONFIG.pagingChartTypes.indexOf(s)>-1;if(this._isEnablePaging()){this._initPagination(true);}else{var e=this._getDataset();if(e){e.setPagingOption(null);}}this._invalidateBy({source:this,keys:{vizFrame:true}});return this;};t.prototype.removeDimension=function(d){var e=this.removeAggregation("dimensions",d);if(e){var v=this._getVisibleDimensions()||[],i=v.indexOf(e.getName());if(i!==-1){v.splice(i,1);this.setVisibleDimensions(v);}}return e;};t.prototype.removeAllDimensions=function(){var d=this.removeAllAggregation("dimensions");this.setVisibleDimensions([]);return d;};t.prototype.destroyDimensions=function(){var d=this.destroyAggregation("dimensions");this.setVisibleDimensions([]);return d;};t.prototype.removeMeasure=function(m){var d=this.removeAggregation("measures",m);if(d){var v=this._getVisibleMeasures()||[],i=v.indexOf(d.getName());if(i!==-1){v.splice(i,1);this.setVisibleMeasures(v);}}return d;};t.prototype.removeAllMeasures=function(){var d=this.removeAllAggregation("measures");this.setVisibleMeasures([]);return d;};t.prototype.destroyMeasures=function(){var d=this.destroyAggregation("measures");this.setVisibleMeasures([]);return d;};t.prototype._getVisibleDimensions=function(n){var s=this._getDrillStateTop();var d=s?s.dimensions:this.getProperty("visibleDimensions");return n?this._normalizeDorM(d,true):d;};t.prototype.getVisibleDimensions=function(){var v=this._getVisibleDimensions();return this._aFeeds?v.filter(function(d){return this._aFeeds._unused.indexOf(d)===-1;},this):v;};t.prototype._getVisibleMeasures=function(n){var s=this._getDrillStateTop();var m=s?s.measures:this.getProperty("visibleMeasures");return n?this._normalizeDorM(m):m;};t.prototype.getVisibleMeasures=function(){var v=this._getVisibleMeasures();return this._aFeeds?v.filter(function(d){return this._aFeeds._unused.indexOf(d)===-1;},this):v;};t.prototype.setVisibleDimensions=function(d,s){this.setProperty("visibleDimensions",d,s);this._createDrillStack();this._invalidateBy({source:this,keys:{binding:true,dataSet:true,vizFrame:true}});return this;};t.prototype.setVisibleMeasures=function(m,s){this.setProperty("visibleMeasures",m,s);this._createDrillStack();this._invalidateBy({source:this,keys:{binding:true,dataSet:true,vizFrame:true}});return this;};t.prototype.setEnablePagination=function(v,s){if(!this._bSetEnablePagination){this.setProperty("enablePagination",v,s);this._invalidateBy({source:this,keys:{binding:true,dataSet:true,vizFrame:true,drillStack:true}});this._bSetEnablePagination=true;}};t.prototype._prepareFeeds=function(){if(!this._aFeeds){var d=this._normalizeDorM(this._getVisibleDimensions(),true),m=this._normalizeDorM(this._getVisibleMeasures(),false);this._aFeeds=R.fit(this.getChartType(),d,m,"color",this._mDataTypes);}return this._aFeeds;};t.prototype._getUnitBinding=function(v){var d=this._getVizFrame();if(!d||d._pendingDataRequest()||!this._aFeeds){return null;}var s=this.getBinding("data").getContexts(0,1)[0];if(!s){return null;}var e=sap.viz.api.env.Format.numericFormatter(),i=v||d.getVizProperties()||{},U=this._normalizeDorM(this._getVisibleMeasures(),false).reduce(function(m,k){m[k.getName()]=k.getUnitBinding();return m;},{});function j(m){var k={};if(i.plotArea&&i.plotArea.dataLabel){k.dataLabel=i.plotArea.dataLabel.formatString;}if(k.dataLabel&&k.dataLabel.hasOwnProperty(m)){k.dataLabel=k.dataLabel[m];}if(i.tooltip){k.tooltip=i.tooltip.formatString;}if(k.tooltip&&k.tooltip.hasOwnProperty(m)){k.tooltip=k.tooltip[m];}return k;}var p=this._aFeeds._def.msr.reduce(function(p,m){var k=m.getIdentity(),n=j(k),H=U[k];p.plotArea.dataLabel.formatString[k]=n.dataLabel;p.tooltip.formatString[k]=n.tooltip;if(H&&e&&e.applyUnit){p.plotArea.dataLabel.formatString[k]=e.applyUnit(n.dataLabel,s.getProperty(H));p.tooltip.formatString[k]=e.applyUnit(n.tooltip,s.getProperty(H));}return p;},{plotArea:{dataLabel:{formatString:{}}},tooltip:{formatString:{}}});return p;};t.prototype._applyUnitBinding=function(){if(!this._rendered){this.attachEventOnce("renderComplete",this._applyUnitBinding,this);}var v=this._getVizFrame(),d=this._getUnitBinding();if(d&&v){v.setVizProperties(d);}};t.prototype._normalizeDorM=function(m,i){var d=i?this.getDimensions():this.getMeasures(),L=d.reduce(function(k,p){k[p.getName()]=p;return k;},{}),e=i?b:c;var j=m.reduce(function(j,N){var s;if(typeof N==="string"){s=N;}else if(N instanceof e){s=N.getName();}else{j.errors.push(N);}if(L[s]){j.normalized.push(L[s]);}else{j.errors.push(N);}return j;},{normalized:[],errors:[]});var n=j.normalized;if(j.errors.length>0){n.errors=j.errors;}return n;};t.prototype._redundantsFromSelection=function(){var s=this._getVizFrame().vizSelection();if(!s||s.length===0){return{measureNames:{}};}var m=s.reduce(function(e,i){jQuery.each(i.data,function(k,v){if(!e[k]){e[k]=[];}if(e[k].indexOf(v)===-1){e[k].push(v);}});return e;},{});var d=this._getVisibleDimensions().reduce(function(e,i){var v=m[i];if(v.length===1){e[i]=v[0];}return e;},{});d.measureNames=this._getVisibleMeasures().reduce(function(e,i){if(!m[i]){e[i]=true;}return e;},{});return d;};t.prototype._deriveFilterFromSelection=function(){var v=this._getVisibleDimensions();var d=this._getVizFrame().vizSelection().map(function(s){var i=v.reduce(function(j,k){j.filters.push(new g({path:k,operator:h.EQ,value1:s.data[k]}));j.signature.push(k+"="+s.data[k]);return j;},{filters:[],signature:[]});i.signature=i.signature.join(";");return i;});var U=d.reduce(function(m,i){if(!m[i.signature]&&i.filters.length>0){m[i.signature]=new g(i.filters,true);}return m;},{});var e=Object.keys(U).map(function(k){return U[k];});if(e.length>1){return new sap.ui.model.Filter(e,false);}else if(e.length===1){return e[0];}else{return null;}};t.prototype._checkDrilldownValid=function(i){var v=this._getVisibleDimensions().reduce(function(e,j){e[j]=true;return e;},{});if(i.some(function(e){return v[e.getName()];})){jQuery.sap.log.error("Drill down not possible, because one of the given dimensions is already drilled down!");return false;}var m=i.reduce(function(e,j){e[j.getName()]=j;return e;},{});function d(e){if(jQuery.isArray(e.aFilters)){return e.aFilters.some(d);}else{return!!m[e.sPath];}}var s=this._getDrillStateTop();if(s&&s.filter&&d(s.filter)){jQuery.sap.log.error("Drill down not possible, because one of the given dimensions is already filtered!");return false;}return true;};t.prototype._createDrillStack=function(){var v=this.getProperty("visibleDimensions")||[],d=this.getProperty("visibleMeasures")||[],s=[{dimensions:[],measures:d,filter:undefined}],e=[];for(var i=0;i<v.length;i++){e.push(v[i]);s.push({dimensions:e.slice(),measures:d,filter:undefined});}this._drillStateStack=s;};t.prototype._invalidateBy=function(d){var s=d.source;if(s===this){jQuery.each(d.keys||{},function(k,v){this._markForUpdate(k,v);}.bind(this));}else if(s instanceof c&&this._getVisibleMeasures().indexOf(s.getName())!==-1){this._markForUpdate("dataSet",true);this._markForUpdate("vizFrame",true);if(d.property==="unitBinding"){this._markForUpdate("binding",true);}}else if(s instanceof b&&this._getVisibleDimensions().indexOf(s.getName())!==-1){this._markForUpdate("dataSet",true);this._markForUpdate("vizFrame",true);if(s.getDisplayText()&&(d.property==="textProperty"||d.property==="displayText")){this._markForUpdate("binding",true);}}this.invalidate(d);};t.prototype._markForUpdate=function(k,n){if(!this._mNeedToUpdate){this._mNeedToUpdate={};}this._mNeedToUpdate[k]=n;var d=this._updaters.onInvalidate[k];if(d){d.call(this);}};t.prototype._updaters=(function(){function d(i){var T=i.getTextProperty(),I=[{name:i.getName(),grouped:false,inResult:false,visible:true}];if(i.getDisplayText()&&T){I.push({name:T,grouped:false,inResult:false,visible:true});}return I;}function e(m){var U=m.getUnitBinding(),i=[{name:m.getName(),total:false,inResult:false,visible:true}];if(U){i.push({name:U,total:false,inResult:false,visible:true});}return i;}return{onInvalidate:{vizFrame:function(){this._aFeeds=null;}},drillStack:function(){this._createDrillStack();},dataSet:function(){var i=this._getDataset();i.updateData.apply(i,arguments);},binding:function(){var i=this._getDataset().getBinding("data");if(!i){return;}var j=this._getVisibleDimensions(true),m=this._getVisibleMeasures(true);if(i.updateAnalyticalInfo){var k=j.reduce(function(I,n){return I.concat(d(n));},[]).concat(m.reduce(function(I,n){return I.concat(e(n));},[]));i.updateAnalyticalInfo(k);}var s=this._getDrillStateTop();if(j.length>0||m.length>0){this._getVizFrame()._pendingDataRequest(true);this.setBusy(true);}i.filter((s&&s.filter)?s.filter:undefined);this._resetPagingOptions();},vizFrame:function(){var i=this._getDataset(),v=this._getVizFrame(),m=this._mMeasureRange||{};i.removeAllAggregation("dimensions",true);i.removeAllAggregation("measures",true);v.removeAllAggregation("feeds",true);var j=this._prepareFeeds();j._def.dim.forEach(function(n){i.addAggregation("dimensions",n,true);},this);j._def.msr.forEach(function(n){var p=m[n.getIdentity()];if(p){n.setRange([p.min,p.max]);}i.addAggregation("measures",n,true);},this);j.forEach(function(n){v.addFeed(n);});v.invalidate();i.invalidate();v.setVizType(this.getChartType());var k=jQuery.extend(true,this._getDefaultVizProperties(),this._getHostedVizProperties(),this._getPagingVizProperties());v.setVizProperties(k);}};})();t.prototype._getDrillStateTop=function(){return this._drillStateStack?this._drillStateStack[this._drillStateStack.length-1]:null;};t.prototype._getVizFrame=function(){return this.getAggregation("_vizFrame");};t.prototype._getDataset=function(){var v=this._getVizFrame();return v?v.getDataset():null;};t.prototype._bindingChangeListener=function(){var v=this._getVizFrame();this.setBusy(false);if(this._isEnablePaging()){if(this._bNeedTotal){this._initPagination();this._bNeedTotal=false;}else if(this._bNeedPaging){var d=v._states().plot.transform.translate.position;this._updatePage(d);}this._applyUnitBinding();}else{this._mMeasureRange={};v._pendingDataRequest(false);this._applyUnitBinding();v.invalidate();}};t.prototype._initPagination=function(n){var d=this.getBinding("data"),p;if(!d){return;}var T=parseInt(d.getTotalSize(),10);if(T>=0){this._iTotalSize=+T;if(this._iTotalSize>this._iPageSize*2){this._iMaxPageNo=Math.floor(this._iTotalSize/this._iPageSize)-1;this._iRemainingRecords=this._iTotalSize%this._iPageSize;this._bNeedPaging=true;this._iOffset=null;var e=this._iPageSize/this._iTotalSize;p={bEnabled:true,iStartIndex:0,iLength:this._iPageSize,sMode:"reset",thumbRatio:e,iPageNo:0};if(n){this._getVizFrame()._pendingDataRequest(false);}else{this._getVizFrame()._pendingDataRequest(true);this._queryMinMax(this._measureRangeReceivedHandler.bind(this));}}else{this._mMeasureRange={};this._bNeedPaging=false;p={bEnabled:false,iStartIndex:0,iLength:this._iTotalSize};this._getVizFrame()._pendingDataRequest(false);}this._getDataset().setPagingOption(p);}};t.prototype._resetPagingOptions=function(){var d=this.getBinding("data");var e=this._getDataset();if(!e||!d){return;}if(this._isEnablePaging()){var i=this._prepareFeeds();i._order=i._order.filter(function(j){return j!=="MND"&&d.getSortablePropertyNames().indexOf(j)>-1;});if(i._order.length){var s=this._aFeeds._order.map(function(P){return new q(P);});d.sort(s);}this._bNeedTotal=true;var p={bEnabled:false,iStartIndex:0,iLength:this._iPageSize*2,iPageNo:0};e.setPagingOption(p);this._oColorTracker.clear();this._getVizFrame()._runtimeScales(this._oColorTracker.get(),true);}else{e.setPagingOption(null);}this._mMeasureRange={};};t.prototype.addData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "addData" therefore cannot be used programmatically!');};t.prototype.destroyData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "destroyData" therefore cannot be used programmatically!');};t.prototype.getData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "getData" therefore cannot be used programmatically!');};t.prototype.indexOfData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "indexOfData" therefore cannot be used programmatically!');};t.prototype.insertData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "insertData" therefore cannot be used programmatically!');};t.prototype.removeData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "removeData" therefore cannot be used programmatically!');};t.prototype.removeAllData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "removeAllData" therefore cannot be used programmatically!');};t.prototype._getEntitySet=function(p,n){if(!n){n=p.split("/")[1];if(n.indexOf("(")!=-1){n=n.split("(")[0]+"Results";}}return n;};t.prototype._createOData4SAPAnalyticsModel=function(m){var d=null;try{d=new o.Model(new o.Model.ReferenceByModel(m));}catch(e){return undefined;}return d;};t.prototype._setIsAnalyticalProperty=function(d,p,n){if(this.getIsAnalytical()===undefined){this.setIsAnalytical(d.findQueryResultByName(this._getEntitySet(p,n))!==undefined);}};t.prototype.bindAggregation=function(n,d){if(n==="data"){var m=this.getModel(d.model);if(m){var e=this._createOData4SAPAnalyticsModel(m);this._setIsAnalyticalProperty(e,d.path,d.parameters?d.parameters.entitySet:undefined);if(this.getIsAnalytical()){if(d){d.parameters=jQuery.extend(true,{},{analyticalInfo:[{name:""}],useBatchRequests:true,provideGrandTotals:false,provideTotalsResultSize:false,autoexpand:false,reloadSingleUnitMeasures:true,noPaging:true},d.parameters);if(this._isEnablePaging()){var p={noPaging:false};d.parameters=jQuery.extend(true,d.parameters,p);}}O.apply(m);if(e){m.setAnalyticalExtensions(e);}}}}return B.prototype.bindAggregation.apply(this,arguments);};t.prototype._bindAggregation=function(n,d){if(n==="data"){var m=this.getModel(d.model);if(m){var e=this._createOData4SAPAnalyticsModel(m);this._setIsAnalyticalProperty(e,d.path,d.parameters?d.parameters.entitySet:undefined);if(this.getIsAnalytical()){if(d){d.parameters=jQuery.extend(true,{},{analyticalInfo:[{name:""}],useBatchRequests:true,provideGrandTotals:false,provideTotalsResultSize:false,autoexpand:false,reloadSingleUnitMeasures:true,noPaging:true},d.parameters);if(this._isEnablePaging()){var p={noPaging:false};d.parameters=jQuery.extend(true,d.parameters,p);}}O.apply(m);if(e){m.setAnalyticalExtensions(e);}var k=m.getAnalyticalExtensions().findQueryResultByName(this._getEntitySet(d.path,d.parameters?d.parameters.entitySet:undefined));var s={};jQuery.each(k.getAllDimensions(),function(T,v){s[T]=v._oProperty.type;});jQuery.each(k.getAllMeasures(),function(T,v){s[T]=v._oProperty.type;});this._mDataTypes=s;var H=this.getAggregation("dimensions");var I=this.getAggregation("measures");if((H===null||H.length===0)&&(I===null||I.length===0)){var J=k.getEntityType().getQName();J=J.slice(J.lastIndexOf(".")+1);H=k.getAllDimensions();for(var i in H){var K=H[i].getName();this.addDimension(new b({name:K,label:"{/#"+J+"/"+K+"/@sap:label}",textProperty:"{/#"+J+"/"+K+"/@sap:text}"}));}I=k.getAllMeasures();for(var j in I){var L=I[j].getName();this.addMeasure(new c({name:L,label:"{/#"+J+"/"+L+"/@sap:label}"}));}}}}var N=this._getDataset(),P=N.getBinding("data");if(P){P.detachChange(this._bindingChangeListener,this);}N.bindAggregation("data",d);var Q=N.getBinding("data");if(Q){N.getBinding("data").attachChange(this._bindingChangeListener,this);}this._invalidateBy({source:this,keys:{binding:true,vizFrame:true}});}else{B.prototype._bindAggregation.apply(this,arguments);}};t.prototype.unbindAggregation=function(n,s){if(n==="data"){var d=this._getDataset();if(d){d.unbindAggregation.apply(d,arguments);}s=true;}return B.prototype.unbindAggregation.apply(this,[n,s]);};t.prototype.onBeforeRendering=function(){B.prototype.onBeforeRendering.apply(this,arguments);jQuery.each(this._updaters,function(k,d){if(this._mNeedToUpdate[k]){d.call(this);this._mNeedToUpdate[k]=false;}}.bind(this));};t.prototype.onAfterRendering=function(){this._showLoading(this._bLoading);};t.prototype.exit=function(){this._getDataset().unbindAggregation('data',true);B.prototype.exit.apply(this,arguments);var v=this._getVizFrame();if(this._delegateEventHandlers){this._delegateEventHandlers.forEach(function(H){v["detach"+H.name](H.handler,this);delete H.handler;},this);delete this._delegateEventHandlers;}v.detachRenderComplete(this._vizFrameRenderCompleteHandler,this);};t.prototype.applySettings=function(){sap.ui.core.Control.prototype.applySettings.apply(this,arguments);var d=new sap.viz.ui5.data.FlattenedDataset();var e=jQuery.extend(true,{},{'applicationSet':'fiori'},this.getUiConfig());this.setUiConfig(e);var v=new V({width:u(this.getWidth()),height:u(this.getHeight()),vizType:this.getChartType(),uiConfig:this.getUiConfig(),vizProperties:jQuery.extend(true,{'title':{'visible':false}},this._getDefaultVizProperties(),this.getVizProperties(),this._getHostedVizProperties(),this._getPagingVizProperties())});v.setDataset(d);v.attachRenderComplete(null,this._updateLoadingIndicator.bind(this));this._rendered=false;v.attachEventOnce("renderComplete",function(){this._rendered=true;},this);v._pendingDataRequest(true);this.setAggregation("_vizFrame",v);this._delegateEvents();this._bSetEnablePagination=true;this._bNeedTotal=true;this._bNeedPaging=false;this._iPageSize=500;this._oColorTracker=new S();};t.prototype.resetLayout=function(){this._invalidateBy({source:this,keys:{binding:true,vizFrame:true,drillStack:true,dataSet:true}});return this;};var _=(function(){function m(k){return k.reduce(function(L,K){L[K]=true;return L;},{});}function d(v,k){var p=m(v);function s(H){return k.reduce(function(P,I){if(H.hasOwnProperty(I)){P[I]=H[I];}return P;},{});}return function(H,I){return H.filter(function(J){return p[J];}).map(function(J){var K=s(I);K[J]="*";return{data:K};});};}function e(v,k){var p=m(v);return function(s){return{index:s._context_row_number,measures:Object.keys(s).filter(function(H){return p[H];})};};}function i(p){var s={data:{}},H=p.measures,I=p.dimensions;if(H){s.data.measureNames=(H instanceof Array)?{"in":H}:H;}jQuery.each(I||{},function(k,v){s.data[k]=(v instanceof Array)?{"in":v}:v;});return s;}function j(p){var s=p.data;return Object.keys(s).reduce(function(H,k){var v=s[k];if(v.in&&v.in instanceof Array){v=v.in;}if(k==="measureNames"){H.measures=v;}else if(!H.dimensions){H.dimensions={};H.dimensions[k]=v;}else{H.dimensions[k]=v;}return H;},{});}function n(v,k,p,s){var H=d(v,k);return s.reduce(function(I,J){var K=p.getContexts(J.index,1);if(K.length>0){I=I.concat(H(J.measures,K[0].getObject()));}return I;},[]);}return{makeLookUp:m,toVizCtx:d,fromVizCtx:e,toVizCSCtx:i,fromVizCSCtx:j,buildSelectionVizCtx:n,match:function(p,v,s){return Object.keys(p).every(function(k){if(s.indexOf(k)!==-1){return v.hasOwnProperty(k);}else{return p[k]===v[k];}});}};})();t.prototype.setSelectedDataPoints=function(d){if(this.getSelectionMode()!==r.None){var e=this.getBinding("data"),v=this._getVizFrame();if(!e||!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return this;}v.vizSelection([],{clearSelection:true});v.vizSelection(_.buildSelectionVizCtx(this._getVisibleMeasures(),this._getVisibleDimensions(),e,d),{selectionMode:this.getSelectionMode()});}return this;};t.prototype.addSelectedDataPoints=function(d){if(this.getSelectionMode()!==r.None){var e=this.getBinding("data"),v=this._getVizFrame();if(!e||!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return this;}v.vizSelection(_.buildSelectionVizCtx(this._getVisibleMeasures(),this._getVisibleDimensions(),e,d),{selectionMode:r.Multi});}return this;};t.prototype.getSelectedDataPoints=function(){var v=this._getVizFrame();if(!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return{count:0,dataPoints:[]};}var d=_.fromVizCtx(this._getVisibleMeasures(),this._getVisibleDimensions());var s=v.vizSelection(),m=s.map(function(n){return n.data;}).map(d).reduce(function(i,j){var k=j.index;i[k]=jQuery.extend(true,i[k]||{},_.makeLookUp(j.measures));return i;},{});var e=this._getDataset();return{count:s.length,dataPoints:Object.keys(m).map(function(i){var j=parseInt(i,10);return{index:j,measures:Object.keys(m[i]),context:e.findContext({"_context_row_number":j})};})};};t.prototype.removeSelectedDataPoints=function(d){if(this.getSelectionMode()!==r.None){var e=this.getBinding("data"),v=this._getVizFrame();if(!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return this;}var i=this._getVisibleMeasures();var j=this._getVisibleDimensions();var T=_.buildSelectionVizCtx(i,j,e,d);v.vizSelection(T,{deselection:true});}return this;};t.prototype.setSelectedCategories=function(d){if(this.getSelectionMode()!==r.None){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return this;}v.vizSelection([],{clearSelection:true});v.vizSelection(d.map(_.toVizCSCtx),{selectionMode:this.getSelectionMode()});}return this;};t.prototype.addSelectedCategories=function(d){if(this.getSelectionMode()!==r.None){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return this;}v.vizSelection(d.map(_.toVizCSCtx),{selectionMode:r.Multi});}return this;};t.prototype.removeSelectedCategories=function(d){if(this.getSelectionMode()!==r.None){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return this;}v.vizSelection(d.map(_.toVizCSCtx),{deselection:true});}return this;};t.prototype.getSelectedCategories=function(){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return{count:0,categories:[]};}else{var d=v.vizSelection();return{count:d.length,categories:(d.category||[]).map(_.fromVizCSCtx)};}};t.prototype.setSelectedSeries=function(s){if(this.getSelectionMode()!==r.None){var v=this._getVizFrame(),d=this.getSelectionBehavior().toUpperCase();if(!v||d!=="SERIES"){return this;}v.vizSelection([],{clearSelection:true});v.vizSelection(s.map(_.toVizCSCtx),{selectionMode:this.getSelectionMode()});}return this;};t.prototype.addSelectedSeries=function(s){if(this.getSelectionMode()!==r.None){var v=this._getVizFrame(),d=this.getSelectionBehavior().toUpperCase();if(!v||d!=="SERIES"){return this;}v.vizSelection(s.map(_.toVizCSCtx),{selectionMode:r.Multi});}return this;};t.prototype.removeSelectedSeries=function(s){if(this.getSelectionMode()!==r.None){var v=this._getVizFrame(),d=this.getSelectionBehavior().toUpperCase();if(!v||d!=="SERIES"){return this;}v.vizSelection(s.map(_.toVizCSCtx),{deselection:true});}return this;};t.prototype.getSelectedSeries=function(){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="SERIES"){return{count:0,series:[]};}else{var d=v.vizSelection();return{count:d.length,series:(d.series||[]).map(_.fromVizCSCtx)};}};t.prototype.drillDown=function(d){if(d&&!(d instanceof Array)){d=[d];}var e=this._normalizeDorM(d,true);if(e.length===0){return;}if(!this._checkDrilldownValid(e)){jQuery.sap.log.warning("Drill down not possible for "+e+". Already drilled down.");return;}var s=this._getDrillStateTop(),m=this._redundantsFromSelection(),i=this._deriveFilterFromSelection();var n;if(i){n=!(s&&s.filter)?i:new g([i,s.filter],true);}this._drillStateStack.push({dimensions:s.dimensions.slice().concat(e.map(function(k){return k.getName();})).filter(function(k){return!m[k];}),measures:s.measures.filter(function(k){return!m.measureNames[k];}),filter:n,redundant:m});var j=e.map(function(k){return k.getName();});this.fireDrilledDown({dimensions:j});this._invalidateBy({source:this,keys:{binding:true,vizFrame:true}});};t.prototype.drillUp=function(){if(this._drillStateStack.length>1){var p=this._drillStateStack.pop(),s=this._getDrillStateTop();this.fireDrilledUp({dimensions:p.dimensions.filter(function(d){return s.dimensions.indexOf(d)===-1;})});this._invalidateBy({source:this,keys:{binding:true,vizFrame:true}});}};t.prototype.setUiConfig=function(U){this.setProperty("uiConfig",U);if(this._getVizFrame()){this._getVizFrame().setUiConfig(U);}};var w=(function(){var d=["interaction.selectability.mode","interaction.selectability.behavior"];function e(i,p){var j=i,v;v=p.reduce(function(m,n){if(j.hasOwnProperty(n)){m.push({parent:j,val:j[n],key:n});j=j[n];}return m;},[]);if(v.length!==p.length){return;}var k=v.pop();delete k.parent[k.key];while(v.length>0){k=v.pop();if(Object.keys(k.val).length>0){return;}else{delete k.parent[k.key];}}}function s(v,i){var j=jQuery.extend(true,{},v);d.forEach(function(p){delete j[p];e(j,p.split("."));});return j;}return{sanitize:s,modify:function(p,k,i){var P=k.split("."),n=p;while(P.length>1&&n.hasOwnProperty(P[0])){n=n[P.shift()];}var j=P[0];if(P.length===1&&n.hasOwnProperty(j)){n[j]=i(n[j]);}}};})();t.prototype.setVizProperties=function(v){v=w.sanitize(v);var U=this._getUnitBinding(v);w.modify(v,"plotArea.dataLabel.formatString",function(d){return U?U.plotArea.dataLabel.formatString:d;});w.modify(v,"tooltip.formatString",function(d){return U?U.tooltip.formatString:d;});this.setProperty("vizProperties",v);if(this._getVizFrame()){this._getVizFrame().setVizProperties(jQuery.extend({},v));}};t.prototype.getVizProperties=function(){var d=this._getVizFrame();var e=w.sanitize(d?d.getVizProperties():this.getProperty("vizProperties"));function s(i){var j=sap.viz.api.env.Format.numericFormatter();if(!j||jQuery.type(j.stripUnit)!=="function"){return i;}if(jQuery.type(i)==="string"){return j.stripUnit(i);}else if(jQuery.type(i)==="object"){jQuery.each(i,function(k,v){i[k]=j.stripUnit(v);});return i;}else{return i;}}w.modify(e,"plotArea.dataLabel.formatString",s);w.modify(e,"tooltip.formatString",s);return e;};t.prototype.setVizScales=function(v){this.setProperty("vizScales",v);if(this._getVizFrame()){this._getVizFrame().setVizScales(v);}};t.prototype.getVizScales=function(){var v=this._getVizFrame();return v?v.getVizScales():this.getProperty("vizScales");};t.prototype.getVizUid=function(){return this._getVizFrame().getVizUid();};t.prototype.zoom=function(d){this._getVizFrame().zoom(d);};var x=["selectData","deselectData"];t.prototype._delegateEvents=function(){if(this._delegateEventHandlers){return;}var v=this._getVizFrame();this._delegateEventHandlers=x.map(function(e){var n=e.charAt(0).toUpperCase()+e.slice(1);var d=function(i){var p=i.getParameters();delete p.id;this.fireEvent(e,p);};d=d.bind(this);v["attach"+n](null,d);return{name:n,handler:d};},this);this._vizFrameRenderCompleteHandler=G.bind(this);v.attachRenderComplete(null,this._vizFrameRenderCompleteHandler);v.attachEvent("_scroll",E.bind(this));};t.getChartTypes=sap.chart.api.getChartTypes;t.prototype.getAvailableChartTypes=function(){var d=this._getVisibleDimensions(true),m=this._getVisibleMeasures(true),e=this._mDataTypes;return C.CONFIG.chartTypes.reduce(function(i,s){var j=R.compatible(s,d,m,e);if(j.compatible){i.available.push({chart:s});}else{var k={};if(j.error.missing.dim){k.Dimension=j.error.missing.dim;}if(j.error.missing.time){k.DateTimeDimension=j.error.missing.time;}if(j.error.missing.msr){k.Measure=j.error.missing.msr;}i.unavailable.push({chart:s,error:k});}return i;},{available:[],unavailable:[]});};t.prototype._hostedVizProperties={selectionMode:{prop:"interaction.selectability.mode"},selectionBehavior:{prop:"interaction.selectability.behavior"}};t.prototype._getHostedVizProperties=function(){return Object.keys(this._hostedVizProperties).reduce(function(d,p){var s=this._hostedVizProperties[p].prop.split(".").reverse().reduce(function(d,e){var i={};i[e]=d;return i;},this.getProperty(p));return jQuery.extend(true,d,s);}.bind(this),{});};var y="__UI5__ShortIntegerMaxFraction10";var z="__UI5__FloatMaxFraction2";var A="__UI5__ShortIntegerMaxFraction2";t.prototype._getDefaultVizProperties=function(){var d='info/'+this.getChartType();var i=(d.indexOf("info/100_")===0);var I=(d==="info/pie"||d==="info/donut");return jQuery.extend(true,k({},d,["valueAxis.label.formatString","valueAxis2.label.formatString"],i?'':y),k({},d,["legend.formatString","sizeLegend.formatString"],A),k({},d,["plotArea.dataLabel.formatString"],I?'':A),k({},d,["tooltip.formatString"],i?'':z));function s(e,m,v){if(m.length===0){return v;}e=e||{};var p=e[m[0]];e[m[0]]=s(p,m.slice(1),v);return e;}function j(p,m){if(p==null||m.legnth===0){return p;}var e=p[m[0]];if(e&&e.children){return j(e.children,m.slice(1));}return e;}function k(e,m,n,v){var H=sap.viz.api.metadata.Viz.get(m);if(H){var J=H.properties;n.forEach(function(K){K=K.split(".");var p=j(J,K);if(p&&p.hasOwnProperty("defaultValue")){s(e,K,v);}});}return e;}};t.prototype._getPagingVizProperties=function(){if(this._isEnablePaging()){var p={interaction:{zoom:{enablement:false},selectability:{mode:"NONE"}},plotArea:{isFixedDataPointSize:true}};return p;}else{return{};}};t.prototype.setSelectionMode=C.hostVizPropertySetter("selectionMode","interaction.selectability.mode",{convert:function(s){return s?s.toUpperCase():s;},validate:function(s){return[r.Multi,r.Single,r.None].indexOf(s)!==-1&&!this.getEnablePagination();}});t.prototype.getSelectionMode=C.hostVizPropertyGetter("selectionMode","interaction.selectability.mode");t.prototype.setSelectionBehavior=C.hostVizPropertySetter("selectionBehavior","interaction.selectability.behavior",{convert:function(s){return s?s.toUpperCase():s;},validate:function(s){return["DATAPOINT","CATEGORY","SERIES"].indexOf(s)!==-1;}});t.prototype.getSelectionBehavior=C.hostVizPropertyGetter("selectionBehavior","interaction.selectability.behavior");t.prototype.getDimensionByName=function(n){return this.getDimensions().filter(function(d){return d.getName()===n;})[0];};t.prototype.getMeasureByName=function(n){return this.getMeasures().filter(function(m){return m.getName()===n;})[0];};function E(e){if(this._isEnablePaging()&&this._bNeedPaging){var d=e.getParameters().position;this._updatePage(d);}}t.prototype._isEnablePaging=function(){this._bMobile=sap.ui.Device.system.tablet||sap.ui.Device.system.phone;var d=this.getEnablePagination()&&this._bIsPagingChartType&&!this._bMobile;return d;};t.prototype._updatePage=function(d){var v=this._getVizFrame();var i=Math.floor(this._iTotalSize*d/this._iPageSize);i=Math.min(i,this._iMaxPageNo);this._iOffset=null;var s=Math.max((i-1)*this._iPageSize,0);var L,e;if(i===0){L=this._iPageSize;e=this._iPageSize;}else if(i===this._iMaxPageNo){L=this._iPageSize*2+this._iRemainingRecords;e=this._iPageSize+this._iRemainingRecords;}else{L=this._iPageSize*2;e=this._iPageSize;}this._iOffset=(this._iTotalSize*d-i*this._iPageSize)/e;var j=this._getDataset();if(j.getRenderedPageNo()===i){var k={plot:{transform:{translate:{translateByPage:{context:this._middleCtx,offset:this._iOffset}}}}};v._states(k);this._showLoading(false);}else{if(this._pagingTimer){jQuery.sap.clearDelayedCall(this._pagingTimer);}this._pagingTimer=jQuery.sap.delayedCall(50,this,function(){var m=this.getBinding("data").getContexts(s,L);var n=m.some(function(H){return H===undefined;});if(n){j.suppressInvalidate();}else{var p={bEnabled:true,iStartIndex:s,iLength:L,sMode:"update",thumbRatio:null,iPageNo:i};j.setPagingOption(p);j.updateData();v.invalidate();this._oColorTracker.add(this._getVizFrame()._runtimeScales());this._getVizFrame()._runtimeScales(this._oColorTracker.get(),true);}});this._sLoadingTimer=this._sLoadingTimer||jQuery.sap.delayedCall(200,this,function(){this._showLoading(true);});}};function G(e){var p=e.getParameters();delete p.id;if(this._isEnablePaging()&&this._bNeedPaging){if(this._sLoadingTimer){jQuery.sap.clearDelayedCall(this._sLoadingTimer);this._sLoadingTimer=null;}var v=this._getVizFrame();var d=this.getBinding("data");var i=this._getDataset();var j=i.getRenderedPageNo();if(j!==0){var m=j*this._iPageSize-1;this._middleCtx=d.getContexts(m,1)[0].getObject();}else{this._middleCtx=null;}if(this._middleCtx||this._iOffset){var k={plot:{transform:{translate:{translateByPage:{context:this._middleCtx,offset:this._iOffset}}}}};v._states(k);}this._showLoading(false);}this.fireEvent("renderComplete",p);}t.prototype._showLoading=function(L){var $=this.$();if(!$){return;}if(!L){if(this._$loadingIndicator){this._$loadingIndicator.remove();}}else{if(!this._$loadingIndicator){this._$loadingIndicator=this._createLoadingIndicator();}this._updateLoadingIndicator();$.append(this._$loadingIndicator);}this._bLoading=L;};t.prototype._createLoadingIndicator=function(){var $=jQuery(sap.ui.core.BusyIndicatorUtils.getHTML());var d=jQuery("<p>").attr("class","loading-text").text("Loading");d.css({"position":"absolute","transform":"translateY(-3em)","width":"100%","text-align":"center"});d.insertBefore($.children()[0]);return $;};t.prototype._updateLoadingIndicator=function(){var $=this.$();if(!$||!this._$loadingIndicator){return;}var s=this.getChartType(),H=s==="bar"||s.indexOf("horizontal")!==-1;var d=$.find(".v-plot-bound"),T=$.offset(),p={top:T.top,left:T.left,width:$.width(),height:$.height()};if(d.length){var P=d.offset(),e=d[0].getBoundingClientRect();p.top=P.top-1;p.left=P.left;p.width=e.width+1;if(H){p.height=Math.ceil(e.height+1);}else{p.height=Math.floor(e.height+1);}}this._$loadingIndicator.css(p);var i=this._$loadingIndicator.find(".loading-text");i.css({"top":p.height/2,"font-weight":sap.ui.core.theming.Parameters.get("sapUiChartTitleFontWeight"),"font-size":sap.ui.core.theming.Parameters.get("sapUiChartMainTitleFontSize"),"color":sap.ui.core.theming.Parameters.get("sapUiChartMainTitleFontSize")});this._$loadingIndicator.css({"background-color":sap.ui.core.theming.Parameters.get("sapUiExtraLightBG")});};t.prototype._getRequiredDimensions=function(){return this._getVisibleDimensions(true);};t.prototype._getRequiredMeasures=function(){return this._getVisibleMeasures(true);};t.prototype._queryMinMax=function(d){var e=this._getRequiredDimensions().map(function(v){return v.getName();}),m=this._getRequiredMeasures().map(function(v){return v.getName();});var i=m.reduce(function(i,v){i[v]={min:{},max:{}};return i;},{});function j(){var v=m.every(function(H){return i[H].min.requested&&i[H].max.requested;});if(v){d(i);}}function k(v,K,H){i[v][K].requested=true;i[v][K].value=parseFloat(H&&H.results[0][v]);j();}function n(v,K,H){i[v][K].requested=true;i[v][K].error=H;j();}var Q=m.reduce(function(Q,v){return Q.concat({urlParameters:{"$select":e.concat(v).join(","),"$top":1,"$orderby":v+" asc"},success:k.bind(null,v,"min"),error:n.bind(null,v,"min")},{urlParameters:{"$select":e.concat(v).join(","),"$top":1,"$orderby":v+" desc"},success:k.bind(null,v,"max"),error:n.bind(null,v,"max")});},[]);var p=this.getBinding("data"),P=p.getPath(),s=p.getModel();Q.forEach(function(v){s.read(P,v);});return Q;};t.prototype._measureRangeReceivedHandler=function(Q){var m={};jQuery.each(Q,function(s,d){m[s]={min:d.min.value,max:d.max.value};});this._mMeasureRange=m;var v=this._getVizFrame();v._pendingDataRequest(false);this._invalidateBy({source:this,keys:{vizFrame:true}});this.setBusy(false);};return t;});

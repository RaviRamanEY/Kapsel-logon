(function(){"use strict";jQuery.sap.declare("sap.ovp.cards.charts.Utils");sap.ovp.cards.charts.Utils=sap.ovp.cards.charts.Utils||{};sap.ovp.cards.charts.Utils.constants={CHART_QUALIFIER_KEY:"chartAnnotationPath",SELVAR_QUALIFIER_KEY:"selectionAnnotationPath",PREVAR_QUALIFIER_KEY:"presentationAnnotationPath",CHART_DATA_SIZE:"4",ERROR_NO_CHART:"Analytic cards require valid \"chartAnnotationPath\" "+"configured in manifest.json"};sap.ovp.cards.charts.Utils.getQualifier=function(c,a){if(!a){return"";}var s=c.getSetting('ovpCardProperties');if(!s){return"";}var S=s.oData;if(!S){return"";}var f=S&&S[a]?S[a]:"";return f===""?"":f.split("#")[1];};sap.ovp.cards.charts.Utils.wrapInBraces=function(w){return"{"+w+"}";};sap.ovp.cards.charts.Utils.getSapLabel=function(p){var e=this.getModel('ovpCardProperties').getProperty("/entityType");var l=sap.ovp.cards.charts.Utils.getAllColumnLabels(e)[p];return l?l:p;};sap.ovp.cards.charts.Utils.returnDateFormat=function(d){jQuery.sap.require("sap.ui.core.format.DateFormat");var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd-MMM"});return D.format(new Date(d));};sap.ovp.cards.charts.Utils.formatItems=function(c,e,s,p,D,M){var r="";var a=[];var b=[];var f=[];var F=s&&s.SelectOptions;var P=s&&s.Parameters;var S=p&&p.SortOrder;var g;var t;var C;if(P){var h=c.getSetting("dataModel");var j=sap.ovp.cards.AnnotationHelper.resolveParameterizedEntitySet(h,e,s);r+="{path: '"+j+"'";}else{r+="{path: '/"+e.name+"'";}var k=[];var l=null;var n=null;if(!c||!c.getSetting('ovpCardProperties')){jQuery.sap.log.error("Analytic card configuration error");r+="}";return r;}l=c.getSetting('ovpCardProperties').getProperty("/entityType");n=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(l);g=sap.ovp.cards.charts.Utils.getAllColumnTexts(l);C=c.getSetting('ovpCardProperties').getProperty("/filters");if(F){jQuery.each(s.SelectOptions,function(){var d=this.PropertyName.PropertyPath;jQuery.each(this.Ranges,function(){if(this.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"){var m=this.Low.String;if(n&&(n[d].substring(0,7)==="Edm.Int"||n[d].substring(0,11)==='Edm.Decimal')){m=Number(m);}var x={path:d,operator:this.Option.EnumMember.split("/")[1],value1:m};if(this.High){x.value2=this.High.String;}k.push(x);}});});}if(C&&C.length>0){k=k.concat(C);}if(k.length>0){r+=", filters: "+JSON.stringify(k);}if(S){var o=p.SortOrder;if(o.length<1){jQuery.sap.log.warning("OVP-AC: Analytic card: Warning: SortOrder is present in PresentationVariant, "+"but it is empty or not well formed.");}else{var q="";var u;var v;var w;for(var i=0;i<o.length;i++){u=o[i];w=u.Property.PropertyPath;f.push(w);if(typeof u.Descending=="undefined"){v='true';}else{v=u.Descending.Boolean.toLowerCase()=='true'?'true':'false';}q=q+"{path: '"+w+"',descending: "+v+"},";}r+=", sorter: ["+q.substring(0,q.length-1)+"]";}}jQuery.each(M,function(i,m){t=m.Measure.PropertyPath;b.push(t);if(g&&t!=g[t]){b.push(g[t]?g[t]:t);}});jQuery.each(D,function(i,d){t=d.Dimension.PropertyPath;a.push(t);if(g&&t!=g[t]){a.push(g[t]?g[t]:t);}});r+=", parameters: {select:'"+[].concat(a,b).join(",");if(f.length>0){r+=","+f.join(",");}r+="'}";r+=", length: "+sap.ovp.cards.charts.Utils.constants.CHART_DATA_SIZE+"}";return r;};sap.ovp.cards.charts.Utils.formatItems.requiresIContext=true;sap.ovp.cards.charts.Utils.getAllColumnProperties=function(p,e){var f={};var a=e.property;for(var i=0,l=a.length;i<l;i++){if(a[i].hasOwnProperty(p)&&p=="com.sap.vocabularies.Common.v1.Label"){f[a[i].name]=a[i][p].String;}else if(a[i].hasOwnProperty(p)){f[a[i].name]=a[i][p];}else{f[a[i].name]=a[i].name;}}return f;};sap.ovp.cards.charts.Utils.getAllColumnLabels=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("com.sap.vocabularies.Common.v1.Label",e);};sap.ovp.cards.charts.Utils.getAllColumnTexts=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("sap:text",e);};sap.ovp.cards.charts.Utils.getEdmTypeOfAll=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("type",e);};sap.ovp.cards.charts.Utils.formatChartYaxis=function(){jQuery.sap.require("sap.ui.core.format.NumberFormat");var c={locale:function(){},format:function(v,p){if(p=="yValueAxisFormatter"){var n=sap.ui.core.format.NumberFormat.getFloatInstance({style:'short',minFractionDigits:2,maxFractionDigits:2});return n.format(Number(v));}}};jQuery.sap.require("sap.viz.ui5.api.env.Format");sap.viz.ui5.api.env.Format.numericFormatter(c);};sap.ovp.cards.charts.Utils.hideDateTimeAxis=function(v,f){var e=v.getModel('ovpCardProperties').getProperty("/entityType");var a=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(e);var b=v.getFeeds();for(var i=0;i<b.length;i++){if(b[i].getUid()==f){var c=b[i].getValues();for(var j=0;j<c.length;j++){if(a[c[j]]!="Edm.DateTime"){return;}}v.setVizProperties({categoryAxis:{title:{visible:false}}});return;}}};sap.ovp.cards.charts.Utils.LineChart=sap.ovp.cards.charts.Utils.LineChart||{};sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList={};sap.ovp.cards.charts.Utils.LineChart.getVizProperties=function(c,a,b){var r=sap.ovp.cards.charts.Utils.LineChart.getValueAxisFeed(b).split(",");var e=sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed(c,a).split(",");var f=c.getSetting('ovpCardProperties').getProperty("/entityType");var g=sap.ovp.cards.charts.Utils.getAllColumnLabels(f);var v=[];jQuery.each(r,function(i,m){v.push(g[m]);});var h=[];jQuery.each(e,function(i,d){h.push(g[d]);});return"{ valueAxis:{  title:{   visible:true,   text: '"+v.join(",")+"'  },  label:{   formatString:'yValueAxisFormatter'  } }, categoryAxis:{  title:{   visible:true,   text: '"+h.join(",")+"'  },  label:{   formatString:'yValueAxisFormatter'  } }, legend: {  isScrollable: false }, title: {  visible: false }, interaction:{  noninteractiveMode: true,  selectability: {   legendSelection: false,   axisLabelSelection: false,   mode: 'NONE',   plotLassoSelection: false,   plotStdSelection: false  } } }";};sap.ovp.cards.charts.Utils.LineChart.getVizProperties.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.getValueAxisFeed=function(a){var r=[];jQuery.each(a,function(i,m){r.push(m.Measure.PropertyPath);});return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed=function(c,a){var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[];var q;var f;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){f=b[d.Dimension.PropertyPath];r.push(f?f:d.Dimension.PropertyPath);}});if(r.length<1){f=b[a[0].Dimension.PropertyPath];r.push(f?f:a[0].Dimension.PropertyPath);}q=sap.ovp.cards.charts.Utils.getQualifier(c,sap.ovp.cards.charts.Utils.constants.CHART_QUALIFIER_KEY);sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q]=r;return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.getColorFeed=function(c,a){var r=[];var q;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){r.push(d.Dimension.PropertyPath);}});q=sap.ovp.cards.charts.Utils.getQualifier(c,sap.ovp.cards.charts.Utils.constants.CHART_QUALIFIER_KEY);r=jQuery.grep(r,function(v){if(!sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q]){return true;}return v!=sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q][0];});return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.testColorFeed=function(c,d){return sap.ovp.cards.charts.Utils.LineChart.getColorFeed(c,d)!=="";};sap.ovp.cards.charts.Utils.LineChart.testColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart=sap.ovp.cards.charts.Utils.BubbleChart||{};sap.ovp.cards.charts.Utils.BubbleChart.getVizProperties=function(c,d,a){var r=sap.ovp.cards.charts.Utils.BubbleChart.getValueAxisFeed(a).split(",");var b=sap.ovp.cards.charts.Utils.BubbleChart.getValueAxis2Feed(a).split(",");var e=c.getSetting('ovpCardProperties').getProperty("/entityType");var f=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var v=[];jQuery.each(r,function(i,m){v.push(f[m]);});var g=[];jQuery.each(b,function(i,m){g.push(f[m]);});return"{ valueAxis:{  title:{ visible:true, text: '"+v.join(",")+"'  },  label:{ formatString:'yValueAxisFormatter'  } }, valueAxis2:{  title:{ visible:true, text: '"+g.join(",")+"'  },  label:{ formatString:'yValueAxisFormatter'  } }, categoryAxis:{  title:{ visible:true  },  label:{ formatString:'yValueAxisFormatter'  } }, legend: {  isScrollable: false }, title: {  visible: false }, interaction:{  noninteractiveMode: true,  selectability: { legendSelection: false, axisLabelSelection: false, mode: 'NONE', plotLassoSelection: false, plotStdSelection: false  } } }";};sap.ovp.cards.charts.Utils.BubbleChart.getVizProperties.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList=function(a){var r=[null,null,null];jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis1"){if(r[0]===null){r[0]=m.Measure.PropertyPath;}else if(r[1]===null){r[1]=m.Measure.PropertyPath;}else if(r[2]==null){r[2]=m.Measure.PropertyPath;}}});jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis2"){if(r[0]===null){r[0]=m.Measure.PropertyPath;}else if(r[1]===null){r[1]=m.Measure.PropertyPath;}else if(r[2]==null){r[2]=m.Measure.PropertyPath;}}});jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis3"){if(r[0]===null){r[0]=m.Measure.PropertyPath;}else if(r[1]===null){r[1]=m.Measure.PropertyPath;}else if(r[2]==null){r[2]=m.Measure.PropertyPath;}}});return r;};sap.ovp.cards.charts.Utils.BubbleChart.getValueAxisFeed=function(m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(m)[0];};sap.ovp.cards.charts.Utils.BubbleChart.getValueAxis2Feed=function(m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(m)[1];};sap.ovp.cards.charts.Utils.BubbleChart.getBubbleWidthFeed=function(m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(m)[2];};sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed=function(c,a){var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[];var f;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){f=b[d.Dimension.PropertyPath];r.push(f?f:d.Dimension.PropertyPath);}});return r.join(",");};sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed=function(c,a){var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[];var f;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){f=b[d.Dimension.PropertyPath];r.push(f?f:d.Dimension.PropertyPath);}});return r.join(",");};sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.testColorFeed=function(c,d){return sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed(c,d)!=="";};sap.ovp.cards.charts.Utils.BubbleChart.testColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.testShapeFeed=function(c,d){return sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed(c,d)!=="";};sap.ovp.cards.charts.Utils.BubbleChart.testShapeFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.validateMeasuresDimensions=function(v,t){var m=null;var d=null;if(!v.getDataset()){jQuery.sap.log.error("OVP-AC: "+t+" Card Error: No Dataset defined for chart.");return false;}m=v.getDataset().getMeasures();d=v.getDataset().getDimensions();switch(t){case"Bubble":if(m.length!==3||d.length<1||!m[0].getName()||!m[1].getName()||!m[2].getName()||!d[0].getName()){jQuery.sap.log.error("OVP-AC: Bubble Card Error: Enter exactly 3 measures and at least 1 dimension.");return false;}break;case"Donut":if(m.length!==1||d.length!==1||!m[0].getName()||!d[0].getName()){jQuery.sap.log.error("OVP-AC: Donut Card Error: Enter exactly 1 measure and 1 dimension.");return false;}break;case"Line":if(m.length<1||d.length<1||!m[0].getName()||!d[0].getName()){jQuery.sap.log.error("OVP-AC: Line Card Error: Configure at least 1 dimensions and 1 measure.");return false;}break;}return true;};sap.ovp.cards.charts.Utils.checkExists=function(t,a,b,m,l){m=typeof m==="undefined"?false:m;var r=false;var c;if(!t&&m){jQuery.sap.log.error(l+"OVP-AC: Analytic card: Error: "+b+" is mandatory.");return r;}if(!t){jQuery.sap.log.warning(l+"OVP-AC: Analytic card: Warning: "+b+" is missing.");r=true;return r;}c=a[t];if(!c||typeof c!=="object"){var d=m?jQuery.sap.log.error:jQuery.sap.log.warning;d(l+"OVP-AC: Analytic card: Error in "+b+". ("+t+" is not found or not well formed)");return r;}r=true;return r;};sap.ovp.cards.charts.Utils.validateCardConfiguration=function(c){var r=false;if(!c){return r;}var s;var a;var p;var i;var P;var e;var l="";var C;var v=c.getView();if(v){l="["+v.getId()+"] ";}if(!(C=c.getCardPropertiesModel())){jQuery.sap.log.error(l+"OVP-AC: Analytic card: Error in card configuration."+"Could not obtain Cards model.");return r;}e=C.getProperty("/entityType");if(!e||jQuery.isEmptyObject(e)){jQuery.sap.log.error(l+"OVP-AC: Analytic card: Error in card annotation.");return r;}s=C.getProperty("/selectionAnnotationPath");a=C.getProperty("/chartAnnotationPath");p=C.getProperty("/presentationAnnotationPath");i=C.getProperty("/identificationAnnotationPath");P=C.getProperty("/dataPointAnnotationPath");r=this.checkExists(s,e,"Selection Variant",false,l);r=this.checkExists(a,e,"Chart Annotation",true,l)&&r;r=this.checkExists(p,e,"Presentation Variant",false,l)&&r;r=this.checkExists(i,e,"Identification Annotation",true,l)&&r;r=this.checkExists(P,e,"Data Point",false,l)&&r;return r;};}());

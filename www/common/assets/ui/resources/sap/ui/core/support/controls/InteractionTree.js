/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/ui/core/IconPool','sap/m/Popover','sap/m/Text','sap/ui/layout/form/SimpleForm','sap/m/Label','sap/m/Link'],function(q,M,I,P,T,S,L,a){'use strict';var b=M.extend("sap.ui.core.support.controls.InteractionTree",{constructor:function(){this.start=0;this.end=1;}});b.expandIcon='sap-icon://navigation-right-arrow';b.collapseIcon='sap-icon://navigation-down-arrow';var p=200,c;b.prototype.setInteractions=function(i){this.interactions=i;this.updateRanges();};b.prototype.setRange=function(s,e){this.start=s;this.end=e;this.updateRanges();this.update();};b.prototype.updateRanges=function(){var i=this.interactions;if(!i||!i.length){return;}this.startTime=i[0].start;this.endTime=i[i.length-1].end;var r=this.endTime-this.startTime;this.actualStartTime=this.startTime+this.start*r;this.actualEndTime=this.startTime+this.end*r;this.timeRange=this.actualEndTime-this.actualStartTime;};b.prototype.update=function(){if(!this.parent){return;}q(this.parent).find('#'+this.getId()).remove();this.renderAt(this.parent);};b.prototype.renderAt=function(d){this.parent=d;var r=sap.ui.getCore().createRenderManager();this.render(r);r.flush(d);r.destroy();this.attachEvents();this.attachInteractionDetailsPopover();this.attachRequestDetailsPopover();};b.prototype.render=function(r){r.write('<div id="'+this.getId()+'" class="sapUiInteractionTreeContainer">');r.write('<div class="sapUiInteractionGridLinesContainer"></div>');r.write('<ul');r.addClass("sapUiInteractionTree");r.writeClasses();r.write(">");this.renderHeaders(r);var d,e=this.interactions;if(!e||!e.length){return;}for(var i=0;i<e.length;i++){d=e[i];this.renderInteraction(r,d,i);}r.write("</ul>");r.write("</div>");};b.prototype.attachEvents=function(){var t=this,i=q('.sapUiInteractionTreeContainer .sapUiInteractionTree');this.gridContainer=q('.sapUiInteractionTreeContainer .sapUiInteractionGridLinesContainer');this.gridContainerWidth=0;i.bind('click',function(e){var $=q(e.target);if($.hasClass('sapUiInteractionLeft')){t.handleInteractionClick($);}});this.gridContainer.resize(function(e){t.updateGridLines();});q(window).resize(function(e){t.updateGridLines();});t.updateGridLines();};b.prototype.updateGridLines=function(){var g=this.gridContainer,r=this.timeRange,w=this.gridContainer.width();if(this.gridContainerWidth==w){return;}g.empty();g.append('<div style="left:'+(this.getPosition(w,r,0)+6)+'px" class="sapUiInteractionGridLineIntervalText">'+this.formatGridLineDuration(0)+'</div>');var d=this.calculateInterval(w,r);for(var i=d;i<r;i+=d){var e=this.getPosition(w,r,i);if(i+d<r){g.append('<div style="left:'+(e+6)+'px" class="sapUiInteractionGridLineIntervalText">'+this.formatGridLineDuration(i)+'</div>');}g.append('<div style="left:'+e+'px" class="sapUiInteractionGridLine"></div>');}this.gridContainerWidth=w;};b.prototype.calculateInterval=function(w,r){var m=4;var d=Math.max(w*m/200.0,1.0);var e=r/d;var f=Math.pow(10,Math.floor(Math.log(e)/Math.LN10));var g=[10,5,2,1];for(var i=0;i<g.length;i++){var h=g[i];var j=f*h;if(d<(r/j)){break;}e=j;}return e;};b.prototype.getPosition=function(w,r,v){var d=w/r*v;return d;};b.prototype.handleInteractionClick=function($){var d=$.find('.sapUiInteractionTreeIcon');if(!d.length){return;}var e=d.attr('expanded')=='true';var f=d.parent();d.remove();var i=this.getIconHTML(!e);f.children().eq(0).after(i);var g=f.parent().parent();g.toggleClass('sapUiInteractionItemExpanded');var h=parseInt(g.attr('data-interaction-index'),10);this.interactions[h].isExpanded=!e;var j=g.find('ul');var k=e?'slideUp':'slideDown';j.stop(true,true)[k]('fast',function(){j.toggleClass('sapUiHiddenUiInteractionItems');});};b.prototype.renderHeaders=function(r){r.write('<li>');r.write('<div');r.addClass("sapUiInteractionTreeItem");r.addClass("sapUiInteractionItemDiv");r.addClass("sapUiInteractionHeader");r.writeClasses();r.write(">");r.write('<div class="sapUiInteractionTreeItemLeft">');r.write("<div>");r.write('<span class="sapUiInteractionItemComponentText">');r.writeEscaped('Component');r.write('</span>');r.write("<br/>");r.write('<span class="sapUiInteractionItemTriggerText">');r.writeEscaped('Trigger');r.write('</span>');r.write("</div>");r.write('</div>');r.write('<div class="sapUiInteractionTreeItemRight">');r.write('</div>');r.write("</div>");r.write("</li>");};b.prototype.renderInteraction=function(r,d,e){var f,g=d.requests,s=d.sapStatistics;var h=d.start;var k=d.end;if(this.actualStartTime>k||this.actualEndTime<h){return;}r.write('<li data-interaction-index="'+e+'"');if(d.isExpanded){r.addClass('sapUiInteractionItemExpanded');r.writeClasses();}r.write('>');this.renderInteractionDiv(r,d);r.write("<ul");r.addClass("sapUiInteractionItem");if(!d.isExpanded){r.addClass("sapUiHiddenUiInteractionItems");}r.writeClasses();r.write(">");var l;for(var i=0;i<g.length;i++){l=null;f=g[i];for(var j=0;j<s.length;j++){if(s[j].timing&&f.startTime===s[j].timing.startTime){l=s[j];break;}}this.renderRequest(r,d,f,l,i);}r.write("</ul>");r.write("</li>");};b.prototype.renderInteractionDiv=function(r,i){r.write('<div');r.addClass("sapUiInteractionTreeItem");r.addClass("sapUiInteractionItemDiv");r.writeClasses();r.write(">");r.write('<div class="sapUiInteractionLeft sapUiInteractionTreeItemLeft">');r.write("<div>");r.write('<span class="sapUiInteractionItemComponentText">');r.writeEscaped(i.component);r.write('</span>');r.write("<br/>");r.write('<span class="sapUiInteractionItemTriggerText">');r.writeEscaped(i.trigger);r.write('</span>');r.write("</div>");if(i.requests.length){this.renderIcon(r,i.isExpanded);}else{r.write('<div class="sapUiInteractionTreeSpace"></div>');}if(i.sapStatistics.length&&i.requests.length){r.write('<div class="sapUiInteractionHeaderIcon sapUiBlue">H</div>');}r.write('</div>');r.write('<div class="sapUiInteractionTreeItemRight">');var s=Math.max(i.start,this.actualStartTime);var e=Math.min(i.end,this.actualEndTime);var l=100/this.timeRange*(s-this.actualStartTime);var d=100/this.timeRange*(e-this.actualStartTime);var w=d-l;r.write('<span style="margin-left: '+l+'%; width: '+w+'%" class="sapUiInteractionTimeframe sapUiInteractionTimeInteractionFrame"></span>');r.write('</div>');r.write("</div>");};b.prototype.renderRequest=function(r,i,d,s,e){var f=d.fetchStartOffset;var g=f+d.startTime;var h=f+d.startTime+d.duration;if(this.actualStartTime>h||this.actualEndTime<g){return;}r.write('<li');r.addClass("sapUiInteractionTreeItem");r.addClass("sapUiInteractionRequest");r.writeClasses();r.write(">");r.write('<div class="sapUiInteractionTreeItemLeft sapUiInteractionRequestLeft" data-request-index="'+e+'">');var j=d.initiatorType||d.entryType;var k;switch(j){case'OData':k='sapUiRed';break;case'xmlhttprequest':k='sapUiPurple';break;default:k='sapUiAccent8';break;}r.write('<span class="sapUiInteractionRequestIcon '+k+'"></span>');r.write('<span class="sapUiInteractionItemEntryTypeText">');r.writeEscaped(j);r.write('</span>');r.write('</div>');r.write('<div class="sapUiInteractionTreeItemRight"');this.writeAttributesAsCustomData(d,r);this.writeAttributesAsCustomData(s,r);r.write('>');var l=d.requestStart+f;var m=d.responseStart+f;this.renderRequestPart(r,g,l,k+'70');this.renderRequestPart(r,l,m,k);this.renderRequestPart(r,m,h,k+'70');r.write('</div>');r.write("</li>");};b.prototype.writeAttributesAsCustomData=function(d,r){for(var e in d){if(d.hasOwnProperty(e)){r.writeAttribute('data-'+e,d[e]);}}};b.prototype.attachRequestDetailsPopover=function(){var s,d,e,f,g,n,h,j,k,l,t,m,o,r,u,v;var w=this;var x=q('.sapUiInteractionRequest.sapUiInteractionTreeItem .sapUiInteractionTreeItemRight');if(x.length){var y=C();for(var i=0;i<x.length;i++){x[i].addEventListener('click',function(E){if(!c||(c+p<(new Date().getTime()))){B.call(this);A.call(this);z.call(this);var F=q(this).children()[1];y.openBy(F);}});}}function z(){var E=this.getAttribute("data-statistics");if(E){s.addContent(l);s.addContent(t);s.addContent(m);s.addContent(o);s.addContent(r);s.addContent(u);s.addContent(v);m.setText(w.formatDuration(parseFloat(E.substring(E.indexOf("total=")+"total=".length,E.indexOf(",")))));E=E.substring(E.indexOf(",")+1);r.setText(w.formatDuration(parseFloat(E.substring(E.indexOf("fw=")+"fw=".length,E.indexOf(",")))));E=E.substring(E.indexOf(",")+1);v.setText(w.formatDuration(parseFloat(E.substring(E.indexOf("app=")+"app=".length,E.indexOf(",")))));}else{s.removeContent(l);s.removeContent(t);s.removeContent(m);s.removeContent(o);s.removeContent(r);s.removeContent(u);s.removeContent(v);}}function A(){f.setText(this.getAttribute("data-initiatorType"));g.setText(this.getAttribute("data-entryType"));n.setText(this.getAttribute("data-name"));n.setHref(this.getAttribute("data-name"));h.setText(w.formatTime(parseFloat(this.getAttribute("data-fetchStartOffset"))+parseFloat(this.getAttribute("data-startTime"))));j.setText(w.formatTime(parseFloat(this.getAttribute("data-fetchStartOffset"))+parseFloat(this.getAttribute("data-startTime"))+parseFloat(this.getAttribute("data-duration"))));k.setText(w.formatDuration(parseFloat(this.getAttribute("data-duration"))));}function B(){var E=(parseFloat(this.getAttribute("data-connectEnd"))-parseFloat(this.getAttribute("data-connectStart")));var F=(parseFloat(this.getAttribute("data-domainLookupEnd"))-parseFloat(this.getAttribute("data-domainLookupStart")));var G=(parseFloat(this.getAttribute("data-redirectEnd"))-parseFloat(this.getAttribute("data-redirectStart")));var H=E+F+G;var J=parseFloat(this.getAttribute("data-responseStart"))-parseFloat(this.getAttribute("data-requestStart"));var K=parseFloat(this.getAttribute("data-responseEnd"))-parseFloat(this.getAttribute("data-responseStart"));var N=(J/(J+K+H))*100;var O=(K/(J+K+H))*100;var Q=(H/(J+K+H))*100;var R=Math.round(H*100)/100;var U=Math.round(J*100)/100;var V=Math.round(K*100)/100;d.setText("Preprocessing / Server / Client ("+R+"ms / "+U+"ms / "+V+"ms)");e.setContent("<div class='sapUiSupportIntProgressBarParent'><span class='sapUiSupportIntProgressBarPreprocess' style=\"width:calc("+Q+"% - 1px)\"></span><span class='sapUiSupportIntProgressBarSeparator'></span><span class='sapUiSupportIntProgressBarClient' style=\"width:calc("+N+"% - 1px)\"></span>"+"<span class='sapUiSupportIntProgressBarSeparator'></span><span class='sapUiSupportIntProgressBarServer' style=\"width:calc("+O+"% - 1px)\"></span></div>");}function C(){var y=new P({placement:sap.m.PlacementType.Auto,contentWidth:"450px",showHeader:false,showArrow:true,verticalScrolling:true,horizontalScrolling:false,content:[D()],afterClose:w.setPopoverCloseTimestamp});y.attachAfterOpen(function(E){E.getSource().$().focus();});return y;}function D(){d=new sap.ui.core.Title();e=new sap.ui.core.HTML();f=new T().addStyleClass("sapUiSupportIntRequestText");g=new T().addStyleClass("sapUiSupportIntRequestText");n=new a({target:"_blank",wrapping:true}).addStyleClass("sapUiSupportIntRequestLink");h=new T().addStyleClass("sapUiSupportIntRequestText");j=new T().addStyleClass("sapUiSupportIntRequestText");k=new T().addStyleClass("sapUiSupportIntRequestText");l=new sap.ui.core.Title({text:"SAP Statistics for OData Calls"});t=new sap.m.Label({text:"Gateway Total"}).addStyleClass("sapUiSupportIntRequestLabel");m=new T().addStyleClass("sapUiSupportIntRequestText");o=new sap.m.Label({text:"Framework"}).addStyleClass("sapUiSupportIntRequestLabel");r=new T().addStyleClass("sapUiSupportIntRequestText");u=new sap.m.Label({text:"Application"}).addStyleClass("sapUiSupportIntRequestLabel");v=new T().addStyleClass("sapUiSupportIntRequestText");s=new sap.ui.layout.form.SimpleForm({maxContainerCols:2,minWidth:400,labelMinWidth:100,editable:false,layout:"ResponsiveGridLayout",labelSpanM:5,emptySpanM:0,columnsM:1,breakpointM:0,content:[d,e,new sap.ui.core.Title({text:"Request Data"}),new sap.m.Label({text:"Initiator Type"}).addStyleClass("sapUiSupportIntRequestLabel"),f,new sap.m.Label({text:"Entry Type"}).addStyleClass("sapUiSupportIntRequestLabel"),g,new sap.m.Label({text:"Name"}).addStyleClass("sapUiSupportIntRequestLabel"),n,new sap.m.Label({text:"Start Time"}).addStyleClass("sapUiSupportIntRequestLabel"),h,new sap.m.Label({text:"End Time"}).addStyleClass("sapUiSupportIntRequestLabel"),j,new sap.m.Label({text:"Duration"}).addStyleClass("sapUiSupportIntRequestLabel"),k]});return s;}};b.prototype.attachInteractionDetailsPopover=function(){var s,e,d,r,f,g,h,j,k;var t=this;var l=q('.sapUiInteractionItemDiv.sapUiInteractionTreeItem .sapUiInteractionTreeItemRight');if(l.length){var o=n();for(var i=0;i<l.length;i++){l[i].addEventListener('click',function(v){if(!c||(c+p<(new Date().getTime()))){m.call(this);var w=q(this).children()[0];o.openBy(w);}});}}function m(){var $=q(this).parent().parent();var v=parseInt($.attr('data-interaction-index'),10);var w=t.interactions[v];var x=w.end-w.start;e.setText(t.formatDuration(x));d.setText(t.formatDuration(x-w.roundtrip));r.setText(t.formatDuration(w.requestTime));f.setText(t.formatDuration(w.roundtrip));g.setText(w.bytesReceived);h.setText(w.requests.length);j.setText(t.formatTime(w.start));k.setText(t.formatTime(w.end));}function n(){var o=new P({placement:sap.m.PlacementType.Auto,contentWidth:"450px",showHeader:false,showArrow:true,verticalScrolling:true,horizontalScrolling:false,content:[u()],afterClose:t.setPopoverCloseTimestamp});return o;}function u(){e=new T().addStyleClass("sapUiSupportIntRequestText");d=new T().addStyleClass("sapUiSupportIntRequestText");r=new T().addStyleClass("sapUiSupportIntRequestText");f=new T().addStyleClass("sapUiSupportIntRequestText");g=new T().addStyleClass("sapUiSupportIntRequestText");h=new T().addStyleClass("sapUiSupportIntRequestText");j=new T().addStyleClass("sapUiSupportIntRequestText");k=new T().addStyleClass("sapUiSupportIntRequestText");s=new sap.ui.layout.form.SimpleForm({maxContainerCols:2,minWidth:400,labelMinWidth:100,editable:false,layout:"ResponsiveGridLayout",labelSpanM:5,emptySpanM:0,columnsM:1,breakpointM:0,content:[new sap.ui.core.Title({text:"INTERACTION DATA"}),new sap.m.Label({text:"E2E Duration"}).addStyleClass("sapUiSupportIntRequestLabel"),e,new sap.m.Label({text:"Client Processing Duration"}).addStyleClass("sapUiSupportIntRequestLabel"),d,new sap.m.Label({text:"Total Requests Duration"}).addStyleClass("sapUiSupportIntRequestLabel"),r,new sap.m.Label({text:"Roundtrip Duration"}).addStyleClass("sapUiSupportIntRequestLabel"),f,new sap.m.Label({text:"Bytes Received"}).addStyleClass("sapUiSupportIntRequestLabel"),g,new sap.m.Label({text:"Request Count"}).addStyleClass("sapUiSupportIntRequestLabel"),h,new sap.m.Label({text:"Start Time"}).addStyleClass("sapUiSupportIntRequestLabel"),j,new sap.m.Label({text:"End Time"}).addStyleClass("sapUiSupportIntRequestLabel"),k]});return s;}};b.prototype.setPopoverCloseTimestamp=function(){c=new Date().getTime();};b.prototype.renderRequestPart=function(r,s,e,d){if(this.actualStartTime>e||this.actualEndTime<s){return;}e=Math.min(e,this.actualEndTime);s=Math.max(s,this.actualStartTime);var l=100/this.timeRange*(s-this.actualStartTime);var f=100/this.timeRange*(e-this.actualStartTime);var w=f-l;r.write('<span style="margin-left: '+l+'%; width: '+w+'%" class="sapUiInteractionTimeframe sapUiInteractionTimeRequestFrame '+d+'"></span>');};b.prototype.pad0=function(i,w){return("000"+String(i)).slice(-w);};b.prototype.formatGridLineDuration=function(d){var o=this.actualStartTime-this.startTime;d+=o;return d>100?(d/1000).toFixed(2)+' s':d.toFixed(0)+' ms';};b.prototype.formatDuration=function(d){return d.toFixed(0)+' ms';};b.prototype.formatTime=function(n){var N=new Date(n);return this.pad0(N.getHours(),2)+":"+this.pad0(N.getMinutes(),2)+":"+this.pad0(N.getSeconds(),2)+"."+this.pad0(N.getMilliseconds(),2);};b.prototype.renderIcon=function(r,e){var h=this.getIconHTML(e);r.write(h);};b.prototype.getIconHTML=function(e){var i=e?b.collapseIcon:b.expandIcon;var d="sapUiIcon sapUiInteractionTreeIcon";if(f&&!f.suppressMirroring){d+=" sapUiIconMirrorInRTL";}var h='<span aria-hidden="true" expanded="'+e+'" class="'+d+'" ';var f=I.getIconInfo(i);if(f){h+='data-sap-ui-icon-content="'+f.content+'"';h+=' style="font-family:\'SAP-icons\'"';}h+="></span>";return h;};return b;});

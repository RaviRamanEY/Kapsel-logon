/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2016 SAP SE. All rights reserved
    
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/mvc/Controller','sap/ui/generic/template/library','sap/ui/core/Component','sap/m/MessageToast','sap/ui/table/Table','sap/m/Table','sap/ui/model/Filter','sap/ui/generic/template/ViewUtil','sap/ui/generic/template/ActionUtil','sap/ui/generic/template/MessageUtil','sap/ui/generic/app/util/ModelUtil'],function(q,C,l,a,M,T,R,F,V,A,b,c){"use strict";var B=C.extend("sap.ui.generic.template.BaseViewController",{metadata:{library:"sap.ui.generic.template"}});B.prototype.onInit=function(p){p=p||{};this._fnShowMessages=p.showMessages;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template");this._setCurrentOperation('',null);};B.prototype.getContext=function(){return this.getView().getBindingContext();};B.prototype.getComponent=function(){if(!this._oComponent){this._oComponent=a.getOwnerComponentFor(this.getView());}return this._oComponent;};B.prototype.getComponentContainer=function(){return this.getComponent().getComponentContainer();};B.prototype.getApplicationController=function(){return this.getComponent().getAppComponent().getApplicationController();};B.prototype.getTransactionController=function(){return this.getComponent().getAppComponent().getTransactionController();};B.prototype.getNavigationController=function(){return this.getComponent().getAppComponent().getNavigationController();};B.prototype.getDraftController=function(){return this.getTransactionController().getDraftController();};B.prototype.getDraftContext=function(){return this.getTransactionController().getDraftController().getDraftContext();};B.prototype.editEntity=function(){this._setCurrentOperation(this.operations.editEntity);var t=this;return new Promise(function(r,d){t.getTransactionController().editEntity(t.getContext()).then(function(o){t.getComponentContainer().bindElement(o.context.getPath());t.handleSuccess(o);return r(o.context);},function(e){t.handleError(e);return d(e);});});};B.prototype.deleteEntity=function(d){this._setCurrentOperation(this.operations.deleteEntity);var t=this;var o=this.getContext();var i=this.getDraftController().isActiveEntity(o);var h=this.getDraftController().hasActiveEntity(o);return new Promise(function(r,e){if(i&&d){t.getDraftController().getDraftForActiveEntity(o).then(function(f){t.getTransactionController().deleteEntity(f.context).then(function(){setTimeout(function(){M.show(t._oRb.getText("DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"));},50);return r();});},function(E){t.getComponentContainer().bindElement(o.getPath());t.handleError(E);return e();});}else{t.getTransactionController().deleteEntity(o).then(function(){var E=c.getEntitySetFromContext(o);var D=t.getDraftController().getDraftContext();var f=D.isDraftRoot(E);var m=t._oRb.getText("OBJECT_DELETED");if(!i&&f){m=h?t._oRb.getText("DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"):t._oRb.getText("DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}setTimeout(function(){M.show(m);},50);return r();},function(E){t.getComponentContainer().bindElement(o.getPath());t.handleError(E);return e();});}});};B.prototype.modifyEntity=function(v,o){this._setCurrentOperation(this.operations.modifyEntity);if(!o){return this._modifyEntityOld(v);}var t=this;return new Promise(function(r,d){var e=t.getComponent().getEntitySet();if(!t.getDraftContext().isDraftEnabled(e)){return r();}t.getApplicationController().propertyChanged(e,v,t.getComponentContainer().getElementBinding(),o).then(function(){return r();},function(E){t.handleError(E);return d();});});};B.prototype._modifyEntityOld=function(v){var t=this;return new Promise(function(r,d){var e=t.getComponent().getEntitySet();if(!t.getDraftContext().isDraftEnabled(e)){return r();}if(t.getDraftContext().checkUpdateOnChange(e,v)){t._setRefreshRequiredOnComponents(t.getComponent());}t.getTransactionController().propertyChanged(e,v,t.getComponentContainer().getElementBinding()).then(function(){return r();},function(E){t.handleError(E);return d();});});};B.prototype.saveEntity=function(){this._setCurrentOperation(this.operations.saveEntity);var t=this;return new Promise(function(r,d){t.getTransactionController().triggerSubmitChanges().then(function(o){t.handleSuccess(o);return r(o.context);},function(e){t.handleError(e);return d(e);});});};B.prototype.activateDraftEntity=function(){this._setCurrentOperation(this.operations.activateDraftEntity);var t=this;return new Promise(function(r,d){t.getDraftController().activateDraftEntity(t.getContext()).then(function(o){t.getComponentContainer().unbindElement();t.getComponentContainer().bindElement(o.context.getPath());t.handleSuccess(o);return r(o);},function(e){t.handleError(e);return d(e);});});};B.prototype.prepareDraftEntity=function(){this._setCurrentOperation(this.operations.prepareDraftEntity);var t=this;return new Promise(function(r,d){t.getComponentContainer().unbindElement();t.getDraftController().prepareDraftEntity(t.getContext()).then(function(o){t.handleSuccess(o);return r(o);},function(e){t.handleError(e);return d(e);});});};B.prototype.validateDraftEntity=function(){this._setCurrentOperation(this.operations.validateDraftEntity);var t=this;return new Promise(function(r,d){t.getComponentContainer().unbindElement();t.getDraftController().validateDraftEntity(t.getContext()).then(function(o){t.handleSuccess(o);return r(o);},function(e){t.handleError(e);return d(e);});});};B.prototype._setRefreshRequiredOnComponents=function(o){var d=this.getNavigationController().getViews();for(var s in d){var e=d[s].getComponentInstance();if(e===o){continue;}if(e.setIsRefreshRequired){e.setIsRefreshRequired(true);}}};B.prototype._setCurrentOperation=function(s,p){this._oCurrentOperation={name:s};if(p){this._oCurrentOperation.parameters=p;}};B.prototype._getShowMessages=function(){if(this._fnShowMessages){return this._fnShowMessages();}return true;};B.prototype._getErrorContext=function(p){var r={};p=p||{};try{var e;var d=this.getDraftContext();if(d){var o=p.context||this.getContext();e=o?c.getEntitySetFromContext(o):this.getComponent().getEntitySet();if(e){r.entitySet=e;r.isDraft=d.isDraftEnabled(e);}}r.lastOperation=this._oCurrentOperation;r.showMessages=this._getShowMessages();return r;}catch(f){q.sap.log.error("BaseViewController._getErrorContext threw an exception: "+f);return null;}};B.prototype.handleError=function(e,p){if(!p||!p.errorContext){p={errorContext:this._getErrorContext(p)};}var m=new b({controller:this,response:e});m.handleError(p);};B.prototype.handleSuccess=function(r,p){if(!p){p={successContext:{showMessages:this._getShowMessages()}};}var m=new b({controller:this,response:r});m.handleSuccess(p);};B.prototype.handleActionMessages=function(r,o,p){if(!p){p={showMessages:this._getShowMessages(),errorContext:this._getErrorContext(),action:o};}var m=new b({controller:this,response:r});m.handleActionMessages(p);};B.prototype.callAction=function(p,v,f){var n,s,d,e=[];if(typeof p==="string"){d=p;if(!q.isArray(v)){e.push(v);}else{e=v;}}else{d=p.functionImportPath;if(p.context!=undefined&&p.context!=null){e.push(p.context);}if(p.contexts!=undefined&&p.contexts!=null){e=p.contexts;}s=p.sourceControl;f=p.label;n=p.navigationProperty;}this._setCurrentOperation(this.operations.callAction,{functionImport:d});var t=this;var o=new A({controller:this,contexts:e});var g=function(r){var N=true;var i;if(r.context){i=r.context;}if(q.isArray(i)){N=false;}if(i===e[0]){N=false;}if(N&&i&&i.getPath()!=="/undefined"){if(s){t.navigateFromListItem(i,s);}else{t.getNavigationController().navigateToContext(i,n,false);}}if(q.isArray(i)){t.handleActionMessages(r,o);}else{t.handleSuccess(r);}};var h=function(E){if(q.isArray(E)){t.handleActionMessages(E,o);}else{t.handleError(E,{context:e});}};return o.call(d,f).then(g,h);};B.prototype.navigateFromListItem=function(s,t){var S=null;if(s.getBindingContext){S=s.getBindingContext();}else{S=s;s=null;}var d=S.getPath();var o=this.getComponent();var p="";if(o.getComponentContainer().getElementBinding()){p=o.getComponentContainer().getElementBinding().getPath();}var n=null;if(d.indexOf(p)!==0){if(!t){t=V.getParentTable(s);}n=V.getTableBinding(t).path;}this.getNavigationController().navigateToContext(S,n,false);};B.prototype.searchOnTable=function(t,Q){if(!t){throw new Error("No table","BaseViewController.js");}var o=V.getTableBinding(t);var d={path:o.path,template:o.template,parameters:{custom:{search:Q}}};if(t instanceof T){t.bindRows(d);}else if(t instanceof R){t.bindItems(d);}else{throw new TypeError("searchOnTable not valid on "+t?t.toString():"(null)","BaseViewController.js");}};B.prototype.connectToView=function(v){C.prototype.connectToView.apply(this,arguments);this.getComponent().getAppComponent().getApplicationController().registerView(v);};B.prototype.addEntry=function(t){this._setCurrentOperation(this.operations.addEntry);var n=this.getNavigationController();var s="";var d="";var e=this.getComponent().getEntitySet();var f=this;var E,o,N,m,g;if(!t){throw new Error("Unknown Table");}g=this.getView().getBindingContext();if(g){d=V.getTableBinding(t).path;m=this.getView().getModel().getMetaModel();o=m.getODataEntitySet(e);E=m.getODataEntityType(o.entityType);N=m.getODataAssociationSetEnd(E,d);e=N.entitySet;d='/'+d;s=g.getPath()+d;}else{s="/"+e;}return new Promise(function(r,h){if(f.getDraftContext().isDraftEnabled(e)){f.getDraftController().createNewDraftEntity(e,s).then(function(i){g=i.context;n.navigateToContext(g,d,false);return r(i.context);},function(i){f.handleError(i);return h(i);});}else{g=f.getView().getModel().createEntry(s,{batchGroupId:'Changes',changeSetId:'Changes'});n.navigateToContext(g,d,false);return r(g);}});};B.prototype.showMessagePopover=function(o,t){q.sap.require("sap.m.MessagePopover");var d=sap.ui.require("sap/m/MessagePopover");q.sap.require("sap.m.MessagePopoverItem");var e=sap.ui.require("sap/m/MessagePopoverItem");if(!this._oMessagePopover){this._oMessagePopover=new d();o.addDependent(this._oMessagePopover);}this._oMessagePopover.bindAggregation("items",{path:"message>/",template:new e({description:"{message>description}",type:"{message>type}",title:"{message>message}"})});this.applyMessageContextFilter();if(t||!this._oMessagePopover.isOpen()){this._oMessagePopover.toggle(o);}};B.prototype.applyMessageContextFilter=function(){if(this._oMessagePopover){var d=this.getMessageContextFilter();var f=this._oMessagePopover.getBinding("items");if(f){f.filter(d);}}};B.prototype.getMessageContextFilter=function(){var f=[];if(this.getContext()){var s=this.getContext().getPath();var e="/"+this.getComponent().getEntitySet();var o=new sap.ui.model.Filter([new sap.ui.model.Filter({path:"target",operator:sap.ui.model.FilterOperator.StartsWith,value1:s}),new sap.ui.model.Filter({path:"target",operator:sap.ui.model.FilterOperator.EQ,value1:e}),new sap.ui.model.Filter({path:"validation",operator:sap.ui.model.FilterOperator.EQ,value1:true})],false);f.push(o);}return f;};B.prototype.getTableQueryParameters=function(e,E){var m=this.getView().getModel().getMetaModel();var o=E;var d=m.getODataEntitySet(e,false);var f=m.getODataEntityType(d.entityType,false);var g=f.key.propertyRef;var i;if(this.getDraftContext().isDraftEnabled(e)){g=g.concat(this.getDraftContext().getSemanticKey(e));g.push({name:"IsActiveEntity"},{name:"HasDraftEntity"},{name:"HasActiveEntity"});}if(o.parameters.select&&o.parameters.select.length>0){var s=o.parameters.select.split(',');for(i=0;i<g.length;i++){if(q.inArray(g[i].name,s)===-1){o.parameters.select+=','+g[i].name;}}}return o;};B.operations={callAction:"callAction",addEntry:"addEntry",saveEntity:"saveEntity",deleteEntity:"deleteEntity",editEntity:"editEntity",modifyEntity:"modifyEntity",validateDraftEntity:"validateDraftEntity",prepareDraftEntity:"prepareDraftEntity",activateDraftEntity:"activateDraftEntity"};B.prototype.operations={callAction:B.operations.callAction,addEntry:B.operations.addEntry,saveEntity:B.operations.saveEntity,deleteEntity:B.operations.deleteEntity,editEntity:B.operations.editEntity,modifyEntity:B.operations.modifyEntity,validateDraftEntity:B.operations.validateDraftEntity,prepareDraftEntity:B.operations.prepareDraftEntity,activateDraftEntity:B.operations.activateDraftEntity};return B;},true);

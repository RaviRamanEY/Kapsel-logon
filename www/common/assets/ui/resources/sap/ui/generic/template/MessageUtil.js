/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2016 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","sap/m/MessageBox","sap/m/Dialog","sap/ui/generic/app/util/ModelUtil"],function(q,M,a,D,b){"use strict";var c=M.extend("sap.ui.generic.template.MessageUtil",{metadata:{properties:{controller:{type:"object",group:"Misc",defaultValue:null},response:{type:"object",group:"Misc",defaultValue:null}}}});c.prototype._httpStatusCodes={badRequest:"400",forbidden:"403",methodNotAllowed:"405",preconditionFailed:"428",internalServerError:"500"};c.prototype.handleError=function(p){p=p||{};var e=p.errorContext||{};var E=this.getResponse();var C=this.getController();var m=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ERROR_UNKNOWN");var h;if(E instanceof Error){if(E.message){m=E.message;}}else if(E.response){if(E.response.message){m=E.response.message;}if(E.response.statusCode){h=E.response.statusCode;}if(E.response.headers){for(var H in E.response.headers){if(H.toLowerCase()==='content-type'){var s=E.response.headers[H];if(s.toLowerCase().indexOf('application/json')===0){if(E.response.responseText){var o=JSON.parse(E.response.responseText);if(o&&o.error&&o.error.message&&o.error.message.value){m=o.error.message.value;}}}else{if(E.message){m=E.message;}}break;}}}}var S=true;switch(e.lastOperation.name){case'':break;case C.operations.callAction:break;case C.operations.addEntry:S=false;break;case C.operations.modifyEntity:if(this._httpStatusCodes.preconditionFailed===h){S=false;}break;case C.operations.saveEntity:if(e.isDraft){S=false;}break;case C.operations.deleteEntity:break;case C.operations.editEntity:break;case C.operations.validateDraftEntity:break;case C.operations.prepareDraftEntity:S=false;break;case C.operations.activateDraftEntity:break;default:break;}var d={entitySet:e.entitySet,title:p.title,message:m};if(S){if(e.showMessages){this._showMessageBox(d);}}else{this._showMessagePage(d);}};c.prototype._showMessageBox=function(p){sap.m.MessageBox.show(p.message,{icon:p.messageBoxIcon||sap.m.MessageBox.Icon.ERROR,title:p.title||sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ERROR_TITLE"),actions:[sap.m.MessageBox.Action.OK],onClose:function(A){},styleClass:this._getCompactModeStyleClass()});};c.prototype._showMessagePage=function(p){var n=this.getController().getNavigationController();n.navigateToMessagePage({entitySet:p.entitySet,title:p.title,text:p.message});};c.prototype._getCompactModeStyleClass=function(){if(this.getController().getView().$().closest(".sapUiSizeCompact").length){return"sapUiSizeCompact";}return"";};c.prototype.handleSuccess=function(p){p=p||{};var s=p.successContext||{};var r,m,d;r=this.getResponse();d=this._getMessages(r);if(d&&d.length>0){if(d.length===1){m=d[0];if(m.state===sap.ui.core.ValueState.Success){this._showSuccessToast(m);}else{if(s.showMessages){this._showMessages(d);}}}else{if(s.showMessages){this._showMessages(d);}}}};c.prototype._getMessages=function(r){var m=[];var l,i,R;if(q.isArray(r)){R=r;l=R.length;for(i=0;i<l;i++){m.concat(this._getMessages(R[i]));}return m;}else{r=r.response;}if(!r||!r.statusCode){return;}if(r.statusCode.toString().substring(0,1)==="2"){if(r.headers["sap-message"]){var o=r.headers["sap-message"];var d=JSON.parse(o);m.push(this._getMessage(d));if(d.details){for(var i=0;i<d.details.length;i++){m.push(this._getMessage(d.details[i]));}}}}return m;};c.prototype._getMessage=function(m){var i,s;switch(m.severity){case"info":i="sap-icon://sys-enter";s=sap.ui.core.ValueState.Success;break;case"warning":i="sap-icon://notification";s=sap.ui.core.ValueState.Warning;break;case"error":i="sap-icon://error";s=sap.ui.core.ValueState.Error;break;default:i="sap-icon://sys-enter";s=sap.ui.core.ValueState.Success;break;}var o={message:m.message,code:m.messageCode,target:m.target,icon:i,state:s};return o;};c.prototype._showSuccessToast=function(m){sap.m.MessageToast.show(m.message);};c.prototype._showMessages=function(m){var o,d;var t=this;o=new sap.ui.model.json.JSONModel();o.setData({messages:m});d=new sap.m.Dialog({content:t.getMessageTable(),type:sap.m.DialogType.Message,state:"None",afterClose:function(){d.destroy();},buttons:[new sap.m.Button({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("DIALOG_CLOSE"),press:function(){d.close();}})]});d.setModel(o);d.open();};c.prototype.getMessageTable=function(){var m=new sap.m.Table({growing:false,showSeparators:sap.m.ListSeparators.None,inset:false,fixedLayout:false,backgroundDesign:sap.m.BackgroundDesign.Transparent,columns:[new sap.m.Column({hAlign:"Left",vAlign:"Top"})]});var t=this;var d=new sap.m.ColumnListItem({unread:false,vAlign:"Top",type:"{itemType}",press:function(e){t._navigateToDetail(e);},cells:[new sap.ui.layout.Grid({vSpacing:0,hSpacing:1,content:[new sap.m.ObjectStatus({icon:"{icon}",state:"{state}",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"})}),new sap.m.Text({maxLines:3,text:"{message}",layoutData:new sap.ui.layout.GridData({span:"L10 M10 S10"})})]})]});m.bindAggregation("items","/messages",d);return m;};c.prototype.handleActionMessages=function(p){if(!p.showMessages){return;}var A=p.action.getFunctionImportLabel()||"<?>";var r=this.getResponse();var m=sap.ui.getCore().getMessageManager().getMessageModel().getData("/");m=m.filter(function(o){return r.some(function(R){return q.sap.startsWithIgnoreCase(o.target,R.actionContext.sPath);});});var s=false;var S;var C=function(h){if(s){return;}s=m.some(function(o){return o.type===h;});if(s){S=h;}};if(!p.action.getExecutedSuccessfully()){S="Error";s=true;}else{C("Error");C("Warning");C("Info");}if(s){q.sap.require("sap.m.Text");var T=sap.ui.require("sap/m/Text");q.sap.require("sap.m.Button");var B=sap.ui.require("sap/m/Button");q.sap.require("sap.ui.layout.VerticalLayout");var V=sap.ui.require("sap/ui/layout/VerticalLayout");var t;var e=r.filter(function(R){return m.some(function(o){return o.type===S&&q.sap.startsWithIgnoreCase(o.target,R.actionContext.sPath);});}).length;var d;switch(S){case"Error":d=e===1?"ACTION_ERRORS":"ACTION_ERRORS_MULTIPLE";break;case"Warning":d=e===1?"ACTION_WARNINGS":"ACTION_WARNINGS_MULTIPLE";break;}t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText(d,[A,e]);var i=this._createItemTable(r.filter(function(R){return m.some(function(o){return q.sap.startsWithIgnoreCase(o.target,R.actionContext.sPath);});}));var f=new D({title:sap.ui.getCore().getLibraryResourceBundle("sap.m").getText(S==="Error"?"MSGBOX_TITLE_ERROR":"MSGBOX_TITLE_WARNING"),type:'Message',state:S,content:new V({content:[new T({text:t}),i]}),beginButton:new B({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("DIALOG_CLOSE"),press:function(){f.close();}}),afterClose:function(){f.destroy();}});f.addStyleClass(this._getCompactModeStyleClass());f.open();}else{q.sap.require("sap.m.MessageToast");var g=sap.ui.require("sap/m/MessageToast");d=r.length===1?"ACTION_SUCCESS":"ACTION_SUCCESS_MULTIPLE";g.show(sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText(d,[A,r.length]));}};c.prototype._createItemTable=function(C){if(!C.length){return null;}var m=sap.ui.getCore().getMessageManager().getMessageModel().getData("/");var o=new sap.m.Table({growing:false,showSeparators:sap.m.ListSeparators.None,inset:false,fixedLayout:false,backgroundDesign:sap.m.BackgroundDesign.Transparent,columns:[new sap.m.Column({hAlign:"Left",vAlign:"Top"}),new sap.m.Column({hAlign:"Left",vAlign:"Top"})]});var O=function(E){var g=null;return function(E){var s=E.getSource();var p=s.getBindingContext().getObject().actionContext.sPath;if(g){g.close();g=null;}g=t._createMessagePopover(p);g.openBy(s);};};var t=this;var d=new sap.m.ColumnListItem({vAlign:"Top",press:function(E){var g=E.getSource().getBindingContext().getObject();t.getController().navigateFromListItem(g.actionContext);},cells:[new sap.m.Text({text:"{itemText}:"}),new sap.m.Link({text:"{linkText}",press:O()})]});var e=[];C.forEach(function(g){var i={};i.actionContext=g.actionContext;i.itemText=t._createActionItemText(g.actionContext);var h=m.filter(function(k){return q.sap.startsWithIgnoreCase(k.target,g.actionContext.sPath);});i.linkText="";var j=h.filter(function(k){return k.type==="Error";}).length;if(j===1){i.linkText+=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ACTION_ERROR_COUNT",j)+", ";}else if(j>1){i.linkText+=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ACTION_ERRORS_COUNT",j)+", ";}j=h.filter(function(k){return k.type==="Warning";}).length;if(j===1){i.linkText+=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ACTION_WARNING_COUNT",j)+", ";}else if(j>1){i.linkText+=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ACTION_WARNINGS_COUNT",j)+", ";}if(i.linkText.length>2){i.linkText=i.linkText.substring(0,i.linkText.length-2);}e.push(i);});var f=new sap.ui.model.json.JSONModel();f.setData(e);o.setModel(f);o.bindAggregation("items","/",d);return o;};c.prototype._createMessagePopover=function(p){q.sap.require("sap.m.MessagePopover");var d=sap.ui.require("sap/m/MessagePopover");q.sap.require("sap.m.MessagePopoverItem");var e=sap.ui.require("sap/m/MessagePopoverItem");var m=new d({items:{path:"message>/",template:new e({description:"{message>description}",type:"{message>type}",title:"{message>message}"}),filters:[new sap.ui.model.Filter({path:"target",test:function(v){return q.sap.startsWithIgnoreCase(v,p);}})]},afterClose:function(E){}});m.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");return m;};c.prototype._createActionItemText=function(A){var C=A.getObject();var i="";var k=this._getActionKeys(A);k.forEach(function(K){var o=C[K.name];if(o){i+=o+", ";}});if(i.length>2){i=i.substring(0,i.length-2);}return i;};c.prototype._getActionKeys=function(A){var k=[];var e=b.getEntitySetFromContext(A);var d=this.getController().getDraftContext();if(d){k=d.getSemanticKey(e);}if(!k||k.length===0){var m=this.getController().getView().getModel().getMetaModel();var E=m.getODataEntitySet(e);var o=m.getODataEntityType(E.entityType);k=o.key.propertyRef.filter(function(p){var P=o.property.find(function(f){return f.name===p.name;});return!P["com.sap.vocabularies.Common.v1.FieldControl"]||P["com.sap.vocabularies.Common.v1.FieldControl"].EnumMember!=="com.sap.vocabularies.Common.v1.FieldControlType/Hidden";});if(!k.length){k=o.key.propertyRef;}}return k;};return c;},true);
